<!DOCTYPE html>
<html lang="es" data-theme="claro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>JuriTask</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
</head>
<body>

<!-- ==================== SIDEBAR ==================== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <img src="logo.png" alt="JuriTask" class="logo-img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
      <span class="logo-fallback">âš– JuriTask</span>
    </div>
    <button class="sidebar-toggle" id="sidebarToggle" title="Cerrar menÃº">âœ•</button>
  </div>
  <nav class="sidebar-nav">
    <button class="nav-item active" data-view="all"><span class="nav-icon">â—ˆ</span> Todos los trÃ¡mites</button>
    <button class="nav-item" data-view="today"><span class="nav-icon">â—‰</span> Hoy / Vencidos<span class="badge" id="todayBadge">0</span></button>
    <button class="nav-item" data-view="calendar"><span class="nav-icon">ğŸ“…</span> Calendario</button>
    <button class="nav-item" data-view="finished"><span class="nav-icon">â—</span> Terminados</button>
    <button class="nav-item" data-view="config"><span class="nav-icon">â—«</span> ConfiguraciÃ³n</button>
  </nav>
  <div class="sidebar-filters" id="sidebarFilters">
    <p class="filter-label">Filtros</p>
    <div class="filter-group"><label>Tipo</label>
      <select id="filterTipo"><option value="">Todos</option><option value="abogado">TrÃ¡mites abogado</option><option value="propio">TrÃ¡mites propios</option></select>
    </div>
    <div class="filter-group"><label>Abogado</label><select id="filterAbogado"><option value="">Todos</option></select></div>
    <div class="filter-group"><label>MÃ³dulo</label><select id="filterModulo"><option value="">Todos</option></select></div>
    <div class="filter-group"><label>Responsable seguimiento</label>
      <select id="filterResponsable"><option value="">Todos</option></select>
    </div>
    <div class="filter-group"><label>Etapa</label>
      <select id="filterEtapa"><option value="">Todas</option><option value="gestion">GestiÃ³n</option><option value="seguimiento">Seguimiento</option></select>
    </div>
    <button class="btn-clear-filters" id="clearFilters">Limpiar filtros</button>
  </div>
</aside>

<!-- ==================== MAIN ==================== -->
<div class="app-layout">
  <header class="topbar">
    <button class="menu-btn" id="menuBtn">â˜°</button>
    <div class="topbar-title" id="topbarTitle">Todos los trÃ¡mites</div>
    <div class="topbar-right">
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="Buscarâ€¦" />
        <span class="search-icon">âŒ•</span>
      </div>
      <div class="sort-wrap" id="sortWrap">
        <select id="sortSelect" title="Ordenar porâ€¦">
          <option value="vencimiento">â†‘ Vencimiento</option>
          <option value="seguimiento">â†‘ PrÃ³x. seguimiento</option>
          <option value="mixto">â†‘ MÃ¡s urgente</option>
          <option value="abogado">Abogado Aâ€“Z</option>
          <option value="numero">NÃºmero â†‘</option>
        </select>
      </div>
      <div class="col-switcher" id="colSwitcher">
        <button class="col-btn active" data-cols="1" title="1 columna">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="3" y="2" width="10" height="4" rx="1" fill="currentColor"/><rect x="3" y="7" width="10" height="4" rx="1" fill="currentColor" opacity=".5"/><rect x="3" y="12" width="10" height="2" rx="1" fill="currentColor" opacity=".3"/></svg>
        </button>
        <button class="col-btn" data-cols="2" title="2 columnas">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="5" height="12" rx="1" fill="currentColor"/><rect x="9" y="2" width="5" height="12" rx="1" fill="currentColor" opacity=".5"/></svg>
        </button>
        <button class="col-btn" data-cols="3" title="3 columnas">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="4" height="12" rx="1" fill="currentColor"/><rect x="6" y="2" width="4" height="12" rx="1" fill="currentColor" opacity=".6"/><rect x="11" y="2" width="4" height="12" rx="1" fill="currentColor" opacity=".3"/></svg>
        </button>
      </div>
      <button class="btn-report" id="reportBtn" title="Reporte del dÃ­a">ğŸ“‹ Reporte</button>
      <button class="mob-opts-btn" id="mobOptsBtn" title="Opciones">â‹®</button>
      <button class="btn-primary" id="newTramiteBtn">+ Nuevo</button>
    </div>
  </header>

  <div class="mob-sheet-overlay" id="mobSheetOverlay"></div>
  <div class="mob-sheet" id="mobSheet">
    <div class="mob-sheet-handle"></div>
    <div class="mob-sheet-content">
      <p class="mob-sheet-label">Ordenar por</p>
      <select id="sortSelectMob" class="mob-sheet-select">
        <option value="vencimiento">â†‘ Vencimiento</option><option value="seguimiento">â†‘ PrÃ³x. seguimiento</option>
        <option value="mixto">â†‘ MÃ¡s urgente</option><option value="abogado">Abogado Aâ€“Z</option><option value="numero">NÃºmero â†‘</option>
      </select>
      <p class="mob-sheet-label" style="margin-top:16px">Columnas</p>
      <div class="mob-cols-row">
        <button class="mob-col-btn active" data-cols="1">1 col.</button>
        <button class="mob-col-btn" data-cols="2">2 col.</button>
      </div>
    </div>
  </div>

  <main class="main-content">

    <section class="view active" id="view-all">
      <div class="tramite-list" id="tramiteList"></div>
      <div class="empty-state" id="emptyAll"><div class="empty-icon">ğŸ“‹</div><p>No hay trÃ¡mites. Â¡Crea el primero!</p></div>
    </section>

    <section class="view" id="view-today">
      <p class="view-desc">TrÃ¡mites con seguimiento o vencimiento para hoy o con fecha ya vencida.</p>
      <div class="tramite-list" id="todayList"></div>
      <div class="empty-state" id="emptyToday"><div class="empty-icon">âœ…</div><p>Â¡Todo al dÃ­a!</p></div>
    </section>

    <!-- VISTA CALENDARIO -->
    <section class="view" id="view-calendar">
      <div class="cal-toolbar">
        <button class="btn-icon cal-nav" id="calPrev">â€¹</button>
        <h2 class="cal-month-title" id="calMonthTitle"></h2>
        <button class="btn-icon cal-nav" id="calNext">â€º</button>
        <button class="btn-secondary cal-today-btn" id="calTodayBtn">Hoy</button>
      </div>
      <div class="cal-weekdays">
        <div>Lun</div><div>Mar</div><div>MiÃ©</div><div>Jue</div><div>Vie</div><div>SÃ¡b</div><div>Dom</div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="cal-legend">
        <span class="cal-dot overdue"></span>Vencido
        <span class="cal-dot today"></span>Hoy
        <span class="cal-dot upcoming"></span>Vencimiento
        <span class="cal-dot tarea"></span>Tarea
      </div>
    </section>

    <section class="view" id="view-finished">
      <p class="view-desc">TrÃ¡mites terminados. Se eliminan automÃ¡ticamente a los 30 dÃ­as.</p>
      <div class="tramite-list" id="finishedList"></div>
      <div class="empty-state" id="emptyFinished"><div class="empty-icon">ğŸ—‚ï¸</div><p>No hay trÃ¡mites terminados.</p></div>
    </section>

    <!-- VISTA CONFIGURACIÃ“N -->
    <section class="view" id="view-config">
      <div class="config-card">
        <h2>ConfiguraciÃ³n</h2>

        <div class="config-section">
          <h3>Apariencia</h3>
          <p class="config-hint" style="margin-bottom:12px">Elige el tema de colores de la interfaz.</p>
          <div class="theme-grid" id="themeGrid"></div>
        </div>

        <div class="config-section">
          <h3>Vista de tarjetas</h3>
          <div class="config-row">
            <label>Modo de detalle</label>
            <div class="toggle-group">
              <button class="toggle-btn active" id="modeExpand">Expandir en lugar</button>
              <button class="toggle-btn" id="modeModal">Ventana modal</button>
            </div>
          </div>
          <p class="config-hint"><strong>Expandir</strong> abre la tarjeta hacia abajo. <strong>Ventana modal</strong> abre el panel central.</p>
          <div class="config-row" style="margin-top:14px">
            <label class="autoreq-toggle-label">
              <div class="switch-wrap"><input type="checkbox" id="diasRestantesToggle" /><span class="switch-slider"></span></div>
              Mostrar dÃ­as restantes en tarjetas
            </label>
          </div>
          <p class="config-hint">Muestra cuÃ¡ntos dÃ­as faltan (o han pasado) junto a la fecha de vencimiento.</p>
        </div>

        <div class="config-section">
          <h3>Abogados</h3>
          <p class="config-hint" style="margin-bottom:10px">Edita el nombre y color de cada abogado.</p>
          <div id="abogadosList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px"></div>
          <div class="config-row" style="margin-top:4px;flex-wrap:wrap;gap:8px">
            <input type="text" id="newAbNombre" placeholder="Nombre del nuevo abogadoâ€¦" style="flex:1;min-width:160px" />
            <button class="btn-primary" id="addAbogadoBtn" style="white-space:nowrap">ï¼‹ AÃ±adir abogado</button>
          </div>
          <button class="btn-primary" id="saveAbogadosBtn" style="margin-top:12px">Guardar cambios</button>
        </div>

        <div class="config-section">
          <h3>Colores de barra de progreso</h3>
          <p class="config-hint">Los tres segmentos de la barra superior de cada tarjeta.</p>
          <div class="bar-colors-grid">
            <div class="bar-color-row"><div class="bar-segment-preview" id="barPreview1"></div><label>AnÃ¡lisis</label><input type="color" id="colorBar1" class="color-picker" /></div>
            <div class="bar-color-row"><div class="bar-segment-preview" id="barPreview2"></div><label>Cumplimiento</label><input type="color" id="colorBar2" class="color-picker" /></div>
            <div class="bar-color-row"><div class="bar-segment-preview" id="barPreview3"></div><label>Terminado</label><input type="color" id="colorBar3" class="color-picker" /></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
            <button class="btn-primary" id="saveBarColorsBtn">Guardar colores</button>
            <button class="btn-secondary" id="resetBarColorsBtn">Restablecer</button>
          </div>
        </div>

        <div class="config-section">
          <h3>MÃ³dulos</h3>
          <div id="modulosList" class="modulos-list"></div>
          <div class="config-row modulo-add-row">
            <input type="text" id="newModuloSigla" placeholder="SIGLA" maxlength="8" style="width:90px" />
            <input type="text" id="newModuloNombre" placeholder="Nombre completo" />
            <button class="btn-primary" id="addModuloBtn">Agregar</button>
          </div>
        </div>

        <div class="config-section">
          <h3>Tarea automÃ¡tica al marcar cumplimiento</h3>
          <p class="config-hint" style="margin-bottom:12px">JuriTask puede crear automÃ¡ticamente una tarea de seguimiento al marcar el check de cumplimiento.</p>
          <div class="config-row" style="margin-bottom:14px">
            <label class="autoreq-toggle-label">
              <div class="switch-wrap"><input type="checkbox" id="autoReqToggle" /><span class="switch-slider"></span></div>
              Activar tarea automÃ¡tica
            </label>
          </div>
          <div id="autoReqFields" style="display:flex;flex-direction:column;gap:10px">
            <div class="config-row"><label>Texto</label><input type="text" id="autoReqTexto" placeholder="Ej: 1er req" style="flex:1;min-width:120px" /></div>
            <div class="config-row"><label>DÃ­as despuÃ©s</label><input type="number" id="autoReqDias" min="1" max="365" style="width:80px" /><span style="font-size:13px;color:var(--text-muted)">dÃ­as desde la fecha de marcado</span></div>
            <button class="btn-primary" id="saveAutoReqBtn" style="align-self:flex-start">Guardar</button>
          </div>
        </div>

        <div class="config-section">
          <h3>Datos</h3>
          <p class="config-hint" style="margin-bottom:12px">Exporta o importa todos los datos en formato JSON.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-primary" id="exportBtn">â†‘ Exportar JSON</button>
            <button class="btn-secondary" id="importBtn">â†“ Importar JSON</button>
          </div>
          <input type="file" id="importFile" accept=".json" style="display:none" />
        </div>

        <div class="config-section danger-zone">
          <h3>Zona de peligro</h3>
          <button class="btn-danger" id="clearAllBtn">ğŸ—‘ Borrar todos los datos</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- ==================== MODAL TRÃMITE ==================== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="tramiteModal">
    <div class="modal-header">
      <h2 id="modalTitle">Nuevo trÃ¡mite</h2>
      <button class="modal-close" id="modalClose">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="tipo-toggle-row">
        <button class="tipo-btn active" id="tipoBtnAbogado" data-tipo="abogado">âš– TrÃ¡mite de abogado</button>
        <button class="tipo-btn" id="tipoBtnPropio" data-tipo="propio">ğŸ‘¤ TrÃ¡mite propio</button>
      </div>
      <div class="form-grid" style="margin-top:14px">
        <div class="form-group"><label>NÃºmero / referencia *</label><input type="text" id="fNumero" placeholder="Ej: 64554" autocomplete="off" /></div>
        <div class="form-group"><label>MÃ³dulo *</label><select id="fModulo"></select></div>
        <div class="form-group full"><label>DescripciÃ³n breve *</label><input type="text" id="fDescripcion" placeholder="DescripciÃ³n del trÃ¡mite" /></div>
        <div class="form-group" id="fAbogadoWrap"><label>Abogado responsable *</label><select id="fAbogado"></select></div>
        <div class="form-group"><label>Fecha de vencimiento *</label><input type="date" id="fFechaVencimiento" /></div>
      </div>
      <div class="modal-section">
        <div class="nueva-tarea-header">
          <button class="btn-nueva-tarea" id="btnMostrarTareaModal" type="button">ï¼‹ Nueva tarea</button>
          <span class="nueva-tarea-hint">opcional</span>
        </div>
        <div class="nueva-tarea-fields" id="nuevaTareaFieldsModal" style="display:none">
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group full"><label>DescripciÃ³n de la tarea</label><input type="text" id="fTareaDesc" placeholder="Â¿QuÃ© se debe hacer?" /></div>
            <div class="form-group"><label>Fecha lÃ­mite</label><input type="date" id="fTareaFecha" /></div>
            <div class="form-group" id="fTareaRespWrap"><label>Responsable</label><select id="fTareaResp"></select></div>
          </div>
        </div>
      </div>
      <div class="modal-section">
        <div class="nueva-tarea-header">
          <button class="btn-nueva-tarea" id="btnMostrarNotaModal" type="button">ğŸ“ Agregar nota</button>
          <span class="nueva-tarea-hint">opcional</span>
        </div>
        <div class="nueva-tarea-fields" id="nuevaNotaFieldsModal" style="display:none">
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group full"><label>Nota</label><textarea id="fNota" rows="3" placeholder="Escribe una nota inicialâ€¦"></textarea></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="cancelModal">Cancelar</button>
      <button class="btn-primary" id="saveTramite">Guardar</button>
    </div>
  </div>
</div>

<!-- ==================== MODAL DETALLE ====================
     IMPORTANTE: editDetailBtn y deleteDetailBtn usan onclick directo
     para evitar cualquier problema de bubbling o timing con el overlay.
     La funciÃ³n _detailAction(cmd) lee el id desde data-id en el modal.
-->
<div class="modal-overlay" id="detailOverlay">
  <div class="modal modal-large" id="detailModal" data-id="">
    <div class="modal-header">
      <div>
        <h2 id="detailTitle">TrÃ¡mite #</h2>
        <p id="detailSubtitle" class="modal-subtitle"></p>
      </div>
      <div class="modal-header-actions">
        <button class="btn-icon" title="Duplicar trÃ¡mite" onclick="_detailAction('duplicate')">â§‰</button>
        <button class="btn-icon" title="Editar trÃ¡mite" onclick="_detailAction('edit')">âœ</button>
        <button class="btn-icon btn-icon-danger" title="Eliminar trÃ¡mite" onclick="_detailAction('delete')">ğŸ—‘</button>
        <button class="modal-close" onclick="closeDetail()">âœ•</button>
      </div>
    </div>
    <div class="modal-body detail-body" id="detailModalBody"></div>
  </div>
</div>

<!-- ==================== MODAL REPORTE ==================== -->
<div class="modal-overlay" id="reportOverlay">
  <div class="modal modal-large" id="reportModal">
    <div class="modal-header">
      <div><h2>ğŸ“‹ Reporte del dÃ­a</h2><p class="modal-subtitle" id="reportSubtitle"></p></div>
      <div class="modal-header-actions">
        <button class="btn-icon" id="reportPrintBtn" title="Imprimir / PDF">ğŸ–¨</button>
        <button class="btn-icon" id="reportCopyBtn" title="Copiar texto">â§‰</button>
        <button class="modal-close" id="reportClose">âœ•</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="report-filter-row">
        <label class="report-filter-label">Filtrar por abogado:</label>
        <div class="toggle-group" id="reportFilterGroup">
          <button class="toggle-btn active" data-abogado="">Todos</button>
        </div>
      </div>
      <div id="reportContent"></div>
    </div>
  </div>
</div>

<!-- ==================== CONFIRM DIALOG ==================== -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p class="confirm-msg" id="confirmMsg">Â¿EstÃ¡s seguro?</p>
    <div class="confirm-btns">
      <button class="btn-secondary" id="confirmCancel">Cancelar</button>
      <button class="btn-danger" id="confirmOk">Eliminar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="script.js"></script>
</body>
</html>
